<!DOCTYPE html>  <html> <head>   <title>backbone.btapp.js</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="http://documentcloud.github.com/backbone/docs/docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>            <div id="jump_to">         Jump To &hellip;         <div id="jump_wrapper">           <div id="jump_page">                                           <a class="source" href="docco.html">                 docco               </a>                                           <a class="source" href="backbone.btapp.html">                 backbone.btapp.js               </a>                                           <a class="source" href="node.html">                 node               </a>                        </div>         </div>       </div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               backbone.btapp.js             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Backbone.btapp.js 0.1
(c) 2012 Patrick Williams, BitTorrent Inc.
May be freely distributed under the MIT license.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Welcome to backbone.btapp.js</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>This should provide a clean javascript layer above the utorrent/bittorrent
webui layer (the web interface to a client). It is intended to abstract away 
everything but the objects and the functions that can be called on them. 
There's no need for someone writing    a web app that interacts with the client to 
constantly be doing diffs to see what has changed. In addition, calling long specific 
urls to call a single function on a torrent object is pretty painful, so I added 
functions that dangle off of the objects (in the bt object) that will call the urls 
that will acheive the desired effect and will also handle passing functions as arguments...
this is similar to soap or rpc...so callbacks should <em>just work</em>...in fact, we internally 
rely on this as the    torrentStatus event function is set and the used to keep our models up to date</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>some of us are lost in the world without __asm int 3;</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">assert</span><span class="p">(</span><span class="nx">b</span><span class="p">)</span> <span class="p">{</span> <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">b</span><span class="p">)</span> <span class="kr">debugger</span><span class="p">;</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>If we choose to use falcon we need a global config variable defined/</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nx">config</span> <span class="o">=</span> <span class="p">{</span>
	<span class="nx">srp_root</span><span class="o">:</span><span class="s1">&#39;https://remote-staging.utorrent.com&#39;</span><span class="p">,</span>
<span class="p">};</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>We expect function signatures that come from the client to have a specific syntax</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="kd">function</span> <span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">f</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">f</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\[native function\](\([^\)]*\))+/</span><span class="p">);</span>
<span class="p">}</span>

<span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <h2>Torrent Client (base functionality for Falcon/Local Torrent Clients)</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>TorrentClient provides a very thin wrapper around the web api
It should facilitate finding the correct port and connecting if
necessary to the user computer through falcon...by default uses localhost</p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>TorrentClient is responsible for the mapping between functions
passed to as arguments and the string that proxies them to the client</p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>TorrentClient is responsible for creating functions that wrap around
specific urls that can can be dangled off of models so that when we call
stop on a torrent file, the torrent specific url is accessed without any
effort on the part of the client</p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Keep in mind that because jsonp won't time out naturally, we impose our own
timeouts...this can lead to some less than desirable code :(</p>             </td>             <td class="code">               <div class="highlight"><pre>	
	<span class="nb">window</span><span class="p">.</span><span class="nx">TorrentClient</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">btappCallbacks</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>We can't send function pointers to the torrent client server, so we'll send
the name of the callback, and the server can call this by sending an event with
the name and args back to us. We're responsible for making the call to the function 
when we detect this. This is similar to the way that jsonp makes ajax callbacks.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">storeCallbackFunction</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">cb</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
			<span class="kd">var</span> <span class="nx">str</span> <span class="o">=</span> <span class="s1">&#39;bt_&#39;</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">||</span> <span class="p">(</span><span class="nx">str</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">btappCallbacks</span><span class="p">);</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span> <span class="nx">str</span> <span class="o">+=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">floor</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">random</span><span class="p">()</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span> <span class="p">}</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">btappCallbacks</span><span class="p">[</span><span class="nx">str</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cb</span><span class="p">;</span>
			<span class="k">return</span> <span class="nx">str</span><span class="p">;</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Seeing as we're interfacing with a strongly typed language c/c++ we need to 
ensure that our types are at least close enough to coherse into the desired types
takes something along the lines of "<a href="string,unknown">native function</a>(string)".</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">validateArguments</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">functionValue</span><span class="p">,</span> <span class="nx">variables</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">functionValue</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="k">typeof</span> <span class="nx">variables</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">signatures</span> <span class="o">=</span> <span class="nx">functionValue</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\(.*?\)/g</span><span class="p">);</span>
			<span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">any</span><span class="p">(</span><span class="nx">signatures</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">signature</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">signature</span> <span class="o">=</span> <span class="nx">signature</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/\w+/g</span><span class="p">)</span> <span class="o">||</span> <span class="p">[];</span> <span class="c1">//[&quot;string&quot;,&quot;unknown&quot;]</span>
				<span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">all</span><span class="p">(</span><span class="nx">signature</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span><span class="nx">index</span><span class="p">)</span> <span class="p">{</span> 
					<span class="k">return</span> <span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s1">&#39;unknown&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="k">typeof</span> <span class="nx">variables</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span> <span class="o">===</span> <span class="nx">type</span><span class="p">);</span>
				<span class="p">});</span>
			<span class="p">});</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Functions are simply urls that we make ajax request to. The cb is called with the
result of that ajax request.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">createFunction</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">url</span><span class="p">,</span> <span class="nx">signatures</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="nx">session</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">func</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">cb</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">assert</span><span class="p">(</span><span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">);</span> <span class="c1">//they at least need to provide the callback</span>
				<span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">cb</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">);</span>
				<span class="kd">var</span> <span class="nx">path</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;(&#39;</span><span class="p">;</span>
				<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">[];</span>
				</pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>Lets do a bit of validation of the arguments that we're passing into the client
unfortunately arguments isn't a completely authetic javascript array, so we'll have
to "splice" by hand. All this just to validate the correct types! sheesh...</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="kd">var</span> <span class="nx">native_args</span> <span class="o">=</span> <span class="p">[];</span>
				<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="nx">native_args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This is as close to a static class function as you can get in javascript i guess
we should be able to use verifySignaturesArguments to determine if the client will
consider the arguments that we're passing to be valid</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">validateArguments</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">signatures</span><span class="p">,</span> <span class="nx">native_args</span><span class="p">))</span> <span class="p">{</span>
					<span class="nx">alert</span><span class="p">(</span><span class="nx">signatures</span> <span class="o">+</span> <span class="s1">&#39; cannot accept &#39;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">native_args</span><span class="p">));</span>
					<span class="k">return</span><span class="p">;</span>
				<span class="p">}</span>
				

				<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">arguments</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>We are responsible for converting functions to variable names...
this will be called later via a event with a callback and arguments variables</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">===</span> <span class="s1">&#39;function&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">storeCallbackFunction</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]));</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">arguments</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="nx">path</span> <span class="o">+=</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">args</span><span class="p">));</span>
				<span class="nx">path</span> <span class="o">+=</span> <span class="s1">&#39;)/&#39;</span><span class="p">;</span>
				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;CUSTOM FUNCTION: &#39;</span> <span class="o">+</span> <span class="nx">path</span><span class="p">);</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;function&#39;</span><span class="p">,</span> <span class="p">[</span><span class="nx">path</span><span class="p">],</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{});</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">);</span>
			<span class="nx">func</span><span class="p">.</span><span class="nx">valueOf</span> <span class="o">=</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="k">return</span> <span class="nx">signatures</span><span class="p">;</span> <span class="p">};</span>
			<span class="k">return</span> <span class="nx">func</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">type</span><span class="p">,</span> <span class="nx">queries</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;update&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;state&quot;</span> <span class="o">||</span> <span class="nx">type</span> <span class="o">==</span> <span class="s2">&quot;function&quot;</span><span class="p">);</span>
			<span class="nx">cb</span> <span class="o">=</span> <span class="nx">cb</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span>
			<span class="nx">err</span> <span class="o">=</span> <span class="nx">err</span> <span class="o">||</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>Handle either an array of strings or just a single query.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">queries</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="nx">queries</span> <span class="o">=</span> <span class="p">[</span><span class="nx">queries</span><span class="p">];</span>
			
			<span class="kd">var</span> <span class="nx">args</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="nx">args</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">queries</span><span class="p">)</span> <span class="nx">args</span><span class="p">[</span><span class="s1">&#39;queries&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">queries</span><span class="p">);</span>
			<span class="k">if</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="nx">args</span><span class="p">[</span><span class="s1">&#39;session&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
			
			<span class="kd">var</span> <span class="nx">success_callback</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">data</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="s1">&#39;error&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span>	<span class="nx">err</span><span class="p">();</span>
				<span class="k">else</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">data</span><span class="p">);</span>
			<span class="p">};</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">send_query</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">success_callback</span><span class="p">,</span> <span class="nx">err</span><span class="p">);</span>
		<span class="p">},</span>
	<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h2>Falcon Torrent Client</h2>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Falcon torrent client connections are a bit more involved than a client on the local machine
We have additional javascript dependencies that are substantial enough that we don't load them
unless you open a falcon connection. In addition we have some handshaking with the falcon proxy
that we need to wait for. </p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="kd">var</span> <span class="nx">falcon_initialized</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
	<span class="nb">window</span><span class="p">.</span><span class="nx">FalconTorrentClient</span> <span class="o">=</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>

			<span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;username&#39;</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;password&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">username</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">username</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">password</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">password</span><span class="p">;</span>
			</pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>We only have to load all those expensive js dependencies once...
We can just skip straight to the good stuff (signing in) if we've
done this previously.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">falcon_initialized</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">,</span> <span class="k">this</span><span class="p">));</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
			
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;initializing falcon client&#39;</span><span class="p">);</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;loading falcon external dependencies&#39;</span><span class="p">);</span>
			<span class="kd">var</span> <span class="nx">jsload</span> <span class="o">=</span> <span class="s1">&#39;https://remote-staging.utorrent.com/static/js/jsloadv2.js?v=0.57&#39;</span><span class="p">;</span>
			<span class="nx">$</span><span class="p">.</span><span class="nx">getScript</span><span class="p">(</span><span class="nx">jsload</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">,</span> <span class="nx">textStatus</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;loaded &#39;</span> <span class="o">+</span> <span class="nx">jsload</span><span class="p">);</span>
				<span class="kd">function</span> <span class="nx">create_tags</span><span class="p">(</span><span class="nx">list</span><span class="p">)</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="p">[];</span>
					<span class="kd">var</span> <span class="nx">deps</span> <span class="o">=</span> <span class="p">[];</span>
					<span class="k">for</span> <span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">list</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
						<span class="kd">var</span> <span class="nx">current</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
						<span class="nx">tags</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">current</span> <span class="p">}</span> <span class="p">);</span>
						<span class="nx">deps</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="nx">current</span> <span class="p">);</span>
					<span class="p">}</span>
					<span class="nx">tags</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="p">{</span> <span class="nx">name</span><span class="o">:</span> <span class="nx">list</span><span class="p">[</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
					<span class="nx">requires</span><span class="o">:</span> <span class="nx">deps</span> <span class="p">}</span> <span class="p">);</span>
					<span class="k">return</span> <span class="nx">tags</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="nx">dependencies</span> <span class="o">=</span> <span class="p">[</span>
					<span class="s1">&#39;falcon/deps/SHA-1.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/deps/jsbn.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/deps/jsbn2.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/deps/sjcl.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/deps/sjcl.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/falcon.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/falcon.encryption.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/falcon.api.js&#39;</span><span class="p">,</span>
					<span class="s1">&#39;falcon/falcon.session.js&#39;</span>
				<span class="p">];</span>
				<span class="kd">var</span> <span class="nx">tags</span> <span class="o">=</span> <span class="nx">create_tags</span><span class="p">(</span><span class="nx">dependencies</span><span class="p">);</span>
				<span class="p">(</span><span class="k">new</span> <span class="nx">JSLoad</span><span class="p">(</span><span class="nx">tags</span><span class="p">,</span> <span class="s2">&quot;https://remote-staging.utorrent.com/static/js/&quot;</span><span class="p">)).</span><span class="nx">load</span><span class="p">([</span><span class="s1">&#39;falcon/falcon.session.js&#39;</span><span class="p">],</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
					<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;falcon dependencies loaded...begin exchanging btapp webui information&#39;</span><span class="p">);</span>
					<span class="nx">falcon_initialized</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
				<span class="p">},</span> <span class="k">this</span><span class="p">));</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">));</span>
		<span class="p">},</span>
		<span class="nx">connect</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">falcon</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>set up some connection variables</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="kd">var</span> <span class="nx">opts</span> <span class="o">=</span> <span class="p">{</span>
				<span class="nx">success</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
					<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;raptor connected successfully&#39;</span><span class="p">);</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">falcon</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">api</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;connected&#39;</span><span class="p">);</span>
				<span class="p">},</span> <span class="k">this</span><span class="p">),</span>
				<span class="nx">error</span><span class="o">:</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">,</span> <span class="k">this</span><span class="p">),</span>
			<span class="p">};</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">falcon</span><span class="p">.</span><span class="nx">session</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">.</span><span class="nx">negotiate</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">username</span><span class="p">,</span><span class="k">this</span><span class="p">.</span><span class="nx">password</span><span class="p">,</span> <span class="p">{</span> <span class="nx">success</span><span class="o">:</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">success</span> <span class="p">}</span> <span class="p">);</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>This is the Btapp object's gateway to the actual client requests. These requests look slightly
different than those headed to a local client because they are encrypted.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">send_query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">falcon</span><span class="p">);</span>
			
			<span class="k">this</span><span class="p">.</span><span class="nx">falcon</span><span class="p">.</span><span class="nx">request</span><span class="p">(</span>
				<span class="s1">&#39;POST&#39;</span><span class="p">,</span> 
				<span class="s1">&#39;/client/gui/&#39;</span><span class="p">,</span> 
				<span class="p">{</span><span class="s1">&#39;btapp&#39;</span><span class="o">:</span><span class="s1">&#39;backbone.btapp.js&#39;</span><span class="p">},</span> 
				<span class="nx">args</span><span class="p">,</span> 
				<span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">assert</span><span class="p">(</span><span class="s1">&#39;build&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">);</span>
					<span class="nx">assert</span><span class="p">(</span><span class="s1">&#39;result&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">);</span>
					<span class="nx">cb</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">result</span><span class="p">);</span>
				<span class="p">},</span>
				<span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span> 
					<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;falcon request failed&#39;</span><span class="p">);</span>
					<span class="nx">err</span><span class="p">();</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
				<span class="p">},</span> <span class="k">this</span><span class="p">),</span>
				<span class="p">{}</span>
			<span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">falcon</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">connect</span><span class="p">();</span>
		<span class="p">}</span>
	<span class="p">});</span>
	</pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <h2>Local Torrent Client</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>For clients on the local machine very little setup is neeeded. We have a known port that
the client listens on, so we can just make requests to that. We can also immediately
consider ourselves "connected", which indicates that we're connected to the machine
(for falcon clients we may not ever reach the client even if it is logged into falcon)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">window</span><span class="p">.</span><span class="nx">LocalTorrentClient</span> <span class="o">=</span> <span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">TorrentClient</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;http://localhost:10000/btapp/&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="nx">send_query</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">args</span><span class="p">,</span> <span class="nx">cb</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">$</span><span class="p">.</span><span class="nx">ajax</span><span class="p">({</span>
				<span class="nx">url</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">,</span>
				<span class="nx">dataType</span><span class="o">:</span> <span class="s1">&#39;jsonp&#39;</span><span class="p">,</span>
				<span class="nx">context</span><span class="o">:</span> <span class="k">this</span><span class="p">,</span>
				<span class="nx">data</span><span class="o">:</span> <span class="nx">args</span><span class="p">,</span>
				<span class="nx">success</span><span class="o">:</span> <span class="nx">cb</span><span class="p">,</span>
				<span class="nx">error</span><span class="o">:</span> <span class="nx">err</span><span class="p">,</span>
				<span class="nx">timeout</span><span class="o">:</span> <span class="mi">5000</span>
			<span class="p">});</span>
		<span class="p">},</span>
		<span class="nx">reset</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">defer</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="s1">&#39;connected&#39;</span><span class="p">));</span>
		<span class="p">}</span>		
	<span class="p">});</span>	</pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h2>BtappCollection</h2>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>BtappCollection is a collection of objects in the client...
currently this can only be used to represent the list of torrents,
then within the torrents, their list of files...this will eventually
be used for rss feeds, etc as well.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>BtappModel and BtappCollection both support clearState and updateState</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">window</span><span class="p">.</span><span class="nx">BtappCollection</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Collection</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;destructor&#39;</span><span class="p">,</span> <span class="s1">&#39;clearState&#39;</span><span class="p">,</span> <span class="s1">&#39;updateState&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">initializeValues</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="nx">initializeValues</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">bt</span> <span class="o">=</span> <span class="p">{};</span>
		<span class="p">},</span>
		<span class="nx">destructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Destructing &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">clearState</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">each</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">model</span><span class="p">.</span><span class="nx">clearState</span><span class="p">();</span>
			<span class="p">});</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">destructor</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">initializeValues</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="nx">updateState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>
			
			<span class="nx">add</span> <span class="o">=</span> <span class="nx">add</span> <span class="o">||</span> <span class="p">{};</span>
			<span class="nx">remove</span> <span class="o">=</span> <span class="nx">remove</span> <span class="o">||</span> <span class="p">{};</span>
			</pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>Iterate over the diffs that came from the client to see what has been added (only in add),
removed (only in remove), or changed (old value in remove, new value in add)</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">remove</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
				<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
				</pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>Elements that are in remove aren't necessarily being removed,
they might alternatively be the old value of a variable that has changed</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">added</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>Most native objects coming from the client have an "all" layer before their variables,
There is no need for the additional layer in javascript so we just flatten the tree a bit.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>We only expect objects and functions to be added to collections</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
						<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
						<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">removed</span><span class="p">))</span> <span class="p">{</span>
						<span class="nx">assert</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">);</span>
						<span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
					<span class="p">}</span>					
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">add</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
				<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Most native objects coming from the client have an "all" layer before their variables,
There is no need for the additional layer in javascript so we just flatten the tree a bit.</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>
				
				<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappModel</span><span class="p">({</span><span class="s1">&#39;id&#39;</span><span class="o">:</span><span class="nx">v</span><span class="p">});</span>
						<span class="nx">model</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>
						<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">added</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">createFunction</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">),</span> <span class="nx">added</span><span class="p">);</span>
						
						<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="nx">assert</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">});</span>
	</pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h2>BtappModel</h2>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>BtappModel is the base model for most things in the client
a torrent is a BtappModel, a file is a BtappModel, properties that 
hang off of most BtappModels is also a BtappModel...both BtappModel
and BtappCollection objects are responsible for taking the json object
that is returned by the client and turning that into attributes/functions/etc</p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>BtappModel and BtappCollection both support clearState and updateState</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">window</span><span class="p">.</span><span class="nx">BtappModel</span> <span class="o">=</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;clearState&#39;</span><span class="p">,</span> <span class="s1">&#39;destructor&#39;</span><span class="p">,</span> <span class="s1">&#39;updateState&#39;</span><span class="p">,</span> <span class="s1">&#39;triggerCustomEvents&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">initializeValues</span><span class="p">();</span>
			
			<span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">triggerCustomEvents</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">destructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;Destructing &#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">+</span> <span class="s1">&#39;,&#39;</span> <span class="o">+</span> <span class="k">this</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">unbind</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">triggerCustomEvents</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;destroy&#39;</span><span class="p">);</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <p>Because there is so much turbulance in the properties of models (they can come and go
as clients are disconnected, torrents/peers added/removed, it made sense to be able to
bind to add/remove events on a model for when its attributes change</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">triggerCustomEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">attrs</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">;</span>
			<span class="kd">var</span> <span class="nx">prev</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">previousAttributes</span><span class="p">();</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">attrs</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">a</span> <span class="k">in</span> <span class="nx">prev</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;add:&#39;</span> <span class="o">+</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">a</span><span class="p">]);</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;add&#39;</span><span class="p">,</span> <span class="nx">attrs</span><span class="p">[</span><span class="nx">a</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">p</span> <span class="k">in</span> <span class="nx">prev</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">p</span> <span class="k">in</span> <span class="nx">attrs</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;remove:&#39;</span> <span class="o">+</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">prev</span><span class="p">[</span><span class="nx">p</span><span class="p">]);</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;remove&#39;</span><span class="p">,</span> <span class="nx">prev</span><span class="p">[</span><span class="nx">p</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="nx">initializeValues</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">bt</span> <span class="o">=</span> <span class="p">{};</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="kc">null</span><span class="p">;</span>
		<span class="p">},</span>
		<span class="nx">clearState</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">for</span><span class="p">(</span><span class="nx">a</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">attribute</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">attributes</span><span class="p">[</span><span class="nx">a</span><span class="p">];</span>
				<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">attribute</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;clearState&#39;</span> <span class="k">in</span> <span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
					<span class="nx">attribute</span><span class="p">.</span><span class="nx">clearState</span><span class="p">();</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">destructor</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">clear</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">initializeValues</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="nx">updateState</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">add</span><span class="p">,</span> <span class="nx">remove</span><span class="p">,</span> <span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">session</span> <span class="o">=</span> <span class="nx">session</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span><span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">=</span> <span class="nx">url</span><span class="p">;</span>

			<span class="nx">add</span> <span class="o">=</span> <span class="nx">add</span> <span class="o">||</span> <span class="p">{};</span>
			<span class="nx">remove</span> <span class="o">=</span> <span class="nx">remove</span> <span class="o">||</span> <span class="p">{};</span></pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <p>W're going to iterate over both the added and removed diff trees
because elements that change exist in both trees, we won't delete
elements that exist in remove if they also exist in add...
As a nice verification step, we're also going to verify that the remove
diff tree contains the old value when we change it to the value in the add
diff tree. This should help ensure that we're completely up to date
and haven't missed any state dumps</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">remove</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
				<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
			
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">added</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <p>special case all</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
						<span class="k">continue</span><span class="p">;</span>
					<span class="p">}</span>
					
					<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <p>Update state downstream from here. Then remove from the collection.</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
						<span class="nx">assert</span><span class="p">(</span><span class="nx">model</span><span class="p">);</span>
						<span class="nx">assert</span><span class="p">(</span><span class="s1">&#39;updateState&#39;</span> <span class="k">in</span> <span class="nx">model</span><span class="p">);</span>
						<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">removed</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">removed</span><span class="p">))</span> <span class="p">{</span>
						<span class="nx">assert</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">);</span>
						<span class="k">delete</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="nx">assert</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">==</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">removed</span><span class="p">));</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">unset</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>
			<span class="p">}</span>
			
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">add</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">added</span> <span class="o">=</span> <span class="nx">add</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
				<span class="kd">var</span> <span class="nx">removed</span> <span class="o">=</span> <span class="nx">remove</span><span class="p">[</span><span class="nx">v</span><span class="p">];</span>
				<span class="kd">var</span> <span class="nx">param</span> <span class="o">=</span> <span class="p">{};</span>
				</pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <p>Special case all. It is a redundant layer that exist for the benefit of the torrent client</p>             </td>             <td class="code">               <div class="highlight"><pre>				<span class="k">if</span><span class="p">(</span><span class="nx">v</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <p>Don't recreate a variable we already have. Just update it.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="kd">var</span> <span class="nx">model</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">v</span><span class="p">);</span>
					<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nx">model</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <p>This is the only hard coding that we should do in this library...
As a convenience, torrents and their file/peer lists are treated as backbone collections
the same is true of rss_feeds and filters...its just a more intuitive way of using them</p>             </td>             <td class="code">               <div class="highlight"><pre>						<span class="kd">var</span> <span class="nx">childurl</span> <span class="o">=</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span>	<span class="nx">childurl</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/torrent\/$/</span><span class="p">)</span> <span class="o">||</span>
							<span class="nx">childurl</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/torrent\/all\/[^\/]+\/file\/$/</span><span class="p">)</span> <span class="o">||</span>
							<span class="nx">childurl</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/torrent\/all\/[^\/]+\/peer\/$/</span><span class="p">)</span> <span class="o">||</span>
							<span class="nx">childurl</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/rss_feed\/$/</span><span class="p">)</span> <span class="o">||</span>
							<span class="nx">childurl</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="sr">/btapp\/rss_filter\/$/</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
							<span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappCollection</span><span class="p">;</span>
						<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
							<span class="nx">model</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">BtappModel</span><span class="p">;</span>
						<span class="p">}</span>
						<span class="nx">model</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="nx">model</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">session</span><span class="p">,</span> <span class="nx">added</span><span class="p">,</span> <span class="nx">removed</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span><span class="p">);</span>
					<span class="nx">param</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">model</span><span class="p">;</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">param</span><span class="p">,{</span><span class="nx">server</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span> <span class="o">&amp;&amp;</span> <span class="nx">isFunctionSignature</span><span class="p">(</span><span class="nx">added</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="nx">v</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">))</span> <span class="p">{</span>
						<span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">createFunction</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">url</span> <span class="o">+</span> <span class="nx">escape</span><span class="p">(</span><span class="nx">v</span><span class="p">),</span> <span class="nx">added</span><span class="p">);</span>
						
						<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;change&#39;</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <p>Set non function/object variables as model attributes</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">if</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">added</span> <span class="o">===</span> <span class="s1">&#39;string&#39;</span><span class="p">)</span> <span class="p">{</span>
						<span class="nx">added</span> <span class="o">=</span> <span class="nx">unescape</span><span class="p">(</span><span class="nx">added</span><span class="p">);</span>
					<span class="p">}</span>
					<span class="nx">param</span><span class="p">[</span><span class="nx">v</span><span class="p">]</span> <span class="o">=</span> <span class="nx">added</span><span class="p">;</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <p>We need to specify server:true so that our overwritten set function 
doesn't try to update the client.</p>             </td>             <td class="code">               <div class="highlight"><pre>					<span class="k">this</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">param</span><span class="p">,</span> <span class="p">{</span><span class="nx">server</span><span class="o">:</span><span class="kc">true</span><span class="p">});</span>
				<span class="p">}</span>	
			<span class="p">}</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <p>As a convenience, if you change an attribute on a model, it tries to set that value to the client
This allows you to do things like btapp.get('events').set('torrentStatus', function() {})
In that case, we'll automatically tell the client to set that value.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">set</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <p>If one of the options is server: true, then we shouldn't notify the
server about the set request...otherwise this is likely the web app
that is setting a variable and we should notify the client so it can
update appropriately...in that case don't update our own models...they
will be updated by the server if something in fact changes in the client</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span>	<span class="p">(</span><span class="o">!</span><span class="nx">options</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;server&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nx">options</span><span class="p">[</span><span class="s1">&#39;server&#39;</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
				<span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">bt</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;set&#39;</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">))</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">callback</span> <span class="o">=</span> <span class="p">(</span><span class="nx">options</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;callback&#39;</span> <span class="k">in</span> <span class="nx">options</span><span class="p">)</span> <span class="o">?</span> 
					<span class="nx">options</span><span class="p">[</span><span class="s1">&#39;callback&#39;</span><span class="p">]</span> <span class="o">:</span> 
					<span class="kd">function</span><span class="p">()</span> <span class="p">{</span> <span class="kr">debugger</span><span class="p">;</span> <span class="p">};</span>
				<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">this</span><span class="p">.</span><span class="nx">bt</span><span class="p">[</span><span class="s1">&#39;set&#39;</span><span class="p">](</span><span class="nx">callback</span><span class="p">,</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">[</span><span class="nx">a</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">set</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attributes</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">},</span>
		<span class="nx">get</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attribute</span><span class="p">)</span> <span class="p">{</span>
			<span class="kd">var</span> <span class="nx">ret</span> <span class="o">=</span>  <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">get</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="nx">attribute</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <p>we record model attributes that are accessed so that we can provide trimer
query sets that put much less strain on the client and result in faster/smaller
replies for the client to handle.</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="nx">ret</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">ret</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="s1">&#39;updateState&#39;</span> <span class="k">in</span> <span class="nx">ret</span><span class="p">)))</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">filter</span> <span class="o">=</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">url</span> <span class="o">||</span> <span class="s1">&#39;btapp/&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="nx">attribute</span><span class="p">;</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="nx">filter</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="nx">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h2>Btapp</h2>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <p>Btapp is the root of the client objects' tree, and generally the only object that clients should instantiate.
This mirrors the original api where document.btapp was the root of everything. generally, this api attempts to be
as similar as possible to that one...</p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <p>BEFORE: 
btapp.torrent.get('XXX').file.get('XXX').properties.get('name');
AFTER: 
btapp.get('torrent').get('XXX').get('file').get('XXX').get('properties').get('name');</p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>The primary difference is that in the original you got the state at that exact moment, where
we now simply keep the backbone objects up to date (by quick polling and updating as diffs are returned)
so you can query at your leisure.</p>             </td>             <td class="code">               <div class="highlight"><pre>	</pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <p>EVENTS: there are the following events
appDownloadProgress
filesDragDrop
appStopping
appUninstall
clientMessage
commentNotice
filesAction
rssStatus
torrentStatus</p>             </td>             <td class="code">               <div class="highlight"><pre>		</pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <p>torrentStatus is used internally to keep our objects up to date, but that and clientMessage are really the only
events that are generally used...these trigger events when they are received by the base object, so to listen in
on torrentStatus events, simply provide a callback to btapp.bind('torrentStatus', callback_func)</p>             </td>             <td class="code">               <div class="highlight"><pre>	<span class="nb">window</span><span class="p">.</span><span class="nx">Btapp</span> <span class="o">=</span> <span class="nx">BtappModel</span><span class="p">.</span><span class="nx">extend</span><span class="p">({</span>
		<span class="nx">initialize</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">attributes</span> <span class="o">=</span> <span class="nx">attributes</span> <span class="o">||</span> <span class="p">{};</span>
			<span class="nx">assert</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">attributes</span> <span class="o">===</span> <span class="s1">&#39;object&#39;</span><span class="p">);</span>
			<span class="nx">BtappModel</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">initialize</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <p>initialize variables</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">this</span><span class="p">.</span><span class="nx">poll_frequency</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">poll_frequency</span> <span class="o">||</span> <span class="mi">1000</span><span class="p">;</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">queries</span> <span class="o">=</span> <span class="nx">attributes</span><span class="p">.</span><span class="nx">queries</span> <span class="o">||</span> <span class="p">[</span><span class="s1">&#39;btapp/&#39;</span><span class="p">];</span></pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <p>bind stuff</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="nx">_</span><span class="p">.</span><span class="nx">bindAll</span><span class="p">(</span><span class="k">this</span><span class="p">,</span> <span class="s1">&#39;fetch&#39;</span><span class="p">,</span> <span class="s1">&#39;onEvents&#39;</span><span class="p">,</span> <span class="s1">&#39;onFetch&#39;</span><span class="p">,</span> <span class="s1">&#39;onConnectionError&#39;</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <p>Special case the events because we like to offer the convenience of having bindable
backbone events triggered when the client triggers a btapp event</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;add:events&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">setEvents</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;filter&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">filter</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;FILTER: &#39;</span> <span class="o">+</span> <span class="nx">filter</span><span class="p">);</span> <span class="p">});</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>At this point, if a username password combo is provided we assume that we're trying to
access a falcon client. If not, default to the client running on your local machine</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="s1">&#39;username&#39;</span> <span class="k">in</span> <span class="nx">attributes</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;password&#39;</span> <span class="k">in</span> <span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FalconTorrentClient</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">client</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">LocalTorrentClient</span><span class="p">(</span><span class="nx">attributes</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">eventName</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;client:&#39;</span> <span class="o">+</span> <span class="nx">eventName</span><span class="p">);</span>
			<span class="p">},</span> <span class="k">this</span><span class="p">));</span>
			
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="s1">&#39;connected&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">fetch</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">destructor</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <p>We don't want to destruct the base object even when we can't connect...
Its event bindings are the only way we'll known when we've re-connected
WARNING: this might leak a wee bit if you have numerous connections in your app</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="p">},</span>
		<span class="nx">onConnectionError</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;connection lost...retrying...&#39;</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">clearState</span><span class="p">();</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">reset</span><span class="p">();</span>
		<span class="p">},</span>
		<span class="nx">onFetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">assert</span><span class="p">(</span><span class="s1">&#39;session&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">);</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">waitForEvents</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">session</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">fetch</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;state&#39;</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">queries</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onFetch</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">onConnectionError</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">onEvent</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s1">&#39;event&#39;</span><span class="p">,</span> <span class="nx">data</span><span class="p">);</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <p>There are two types of events...state updates and callbacks
Handle state updates the same way we handle the initial tree building</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">if</span><span class="p">(</span><span class="s1">&#39;add&#39;</span> <span class="k">in</span> <span class="nx">data</span> <span class="o">||</span> <span class="s1">&#39;remove&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="nx">data</span><span class="p">.</span><span class="nx">add</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">add</span> <span class="o">||</span> <span class="p">{};</span>
				<span class="nx">data</span><span class="p">.</span><span class="nx">remove</span> <span class="o">=</span> <span class="nx">data</span><span class="p">.</span><span class="nx">remove</span> <span class="o">||</span> <span class="p">{};</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">updateState</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">add</span><span class="p">.</span><span class="nx">btapp</span><span class="p">,</span> <span class="nx">data</span><span class="p">.</span><span class="nx">remove</span><span class="p">.</span><span class="nx">btapp</span><span class="p">,</span> <span class="s1">&#39;btapp/&#39;</span><span class="p">);</span>
				<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">$</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">add</span><span class="p">).</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span> <span class="o">+</span> <span class="nx">$</span><span class="p">.</span><span class="nx">toJSON</span><span class="p">(</span><span class="nx">data</span><span class="p">.</span><span class="nx">remove</span><span class="p">).</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; bytes added/removed&#39;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="s1">&#39;callback&#39;</span> <span class="k">in</span> <span class="nx">data</span> <span class="o">&amp;&amp;</span> <span class="s1">&#39;arguments&#39;</span> <span class="k">in</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">btappCallbacks</span><span class="p">[</span><span class="nx">data</span><span class="p">.</span><span class="nx">callback</span><span class="p">](</span><span class="nx">data</span><span class="p">.</span><span class="nx">arguments</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="kr">debugger</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">},</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <p>When we get a poll response from the client, we sort through them here, as well as track round trip time.
We also don't fire off another poll request until we've finished up here, so we don't overload the client if
it is generating a large diff tree. We should generally on get one element in data array. Anything more and
the client has wasted energy creating seperate diff trees.</p>             </td>             <td class="code">               <div class="highlight"><pre>		<span class="nx">onEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">time</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">)</span> <span class="p">{</span>
			<span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(((</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">()</span> <span class="o">-</span> <span class="nx">time</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; ms - &#39;</span> <span class="o">+</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">).</span><span class="nx">length</span> <span class="o">+</span> <span class="s1">&#39; bytes&#39;</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">data</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">onEvent</span><span class="p">(</span><span class="nx">session</span><span class="p">,</span> <span class="nx">data</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
			<span class="p">}</span>
			<span class="nx">setTimeout</span><span class="p">(</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">waitForEvents</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">session</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">poll_frequency</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">waitForEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">session</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">this</span><span class="p">.</span><span class="nx">client</span><span class="p">.</span><span class="nx">query</span><span class="p">(</span><span class="s1">&#39;update&#39;</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="nx">session</span><span class="p">,</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">onEvents</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="p">(</span><span class="k">new</span> <span class="nb">Date</span><span class="p">()).</span><span class="nx">getTime</span><span class="p">(),</span> <span class="nx">session</span><span class="p">),</span> <span class="k">this</span><span class="p">.</span><span class="nx">onConnectionError</span><span class="p">);</span>
		<span class="p">},</span>
		<span class="nx">setEvents</span><span class="o">:</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>We assume that we just filled in the events information. We desperately want to
set these so that get all the callbacks from the client...what we want to do is
just have the default event handler trigger an event that has the same name as the event
so if you're using the model you can just do something like 
btapp.bind('clientMessage', onClientMessage) and your handler will receive the info blog
regarding that type of event...it also multiplexes the event handling very nicely</p>             </td>             <td class="code">               <div class="highlight"><pre>			<span class="k">for</span><span class="p">(</span><span class="kd">var</span> <span class="nx">ev</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">attributes</span><span class="p">)</span> <span class="p">{</span>
				<span class="kd">var</span> <span class="nx">arguments</span> <span class="o">=</span> <span class="p">{};</span>
				<span class="nx">arguments</span><span class="p">[</span><span class="nx">ev</span><span class="p">]</span> <span class="o">=</span> <span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">,</span> <span class="k">this</span><span class="p">,</span> <span class="nx">ev</span><span class="p">);</span>
				<span class="kd">var</span> <span class="nx">options</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;callback&#39;</span><span class="o">:</span><span class="nx">_</span><span class="p">.</span><span class="nx">bind</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">ev</span><span class="p">)</span> <span class="p">{</span> <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">&#39;set(&#39;</span> <span class="o">+</span> <span class="nx">ev</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span><span class="p">);</span> <span class="p">},</span> <span class="k">this</span><span class="p">,</span> <span class="nx">ev</span><span class="p">)};</span>
				<span class="k">this</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s1">&#39;events&#39;</span><span class="p">).</span><span class="nx">set</span><span class="p">(</span><span class="nx">arguments</span><span class="p">,</span> <span class="nx">options</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">},</span>
	<span class="p">});</span>
<span class="p">}).</span><span class="nx">call</span><span class="p">(</span><span class="k">this</span><span class="p">);</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 
